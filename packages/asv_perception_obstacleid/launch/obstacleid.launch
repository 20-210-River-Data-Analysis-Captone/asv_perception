<launch>

  <arg name="package_name" value="asv_perception_obstacleid"/>
  <arg name="namespace_name" value="left_camera"/>
  
  <group ns="$(arg namespace_name)">

    <arg name="nodelet_name" value="$(arg package_name)_nodelet" />
    <node pkg="nodelet" type="nodelet" name="$(arg nodelet_name)" args="manager" respawn="true" />

    <!-- 
      Left camera classified extraction, unclassified projection
      See ObstacleProjectionNodelet.h
    -->
    <node pkg="nodelet" type="nodelet" name="projection" respawn="true" output="screen"
      args="load $(arg package_name)/ObstacleProjectionNodelet $(arg nodelet_name)" >

      <remap from="~segmentation" to="segmentation/obstacles" />
      <remap from="~classification" to="classification/output" />
      <remap from="~rgb_radar" to="homography/rgb_radar" />
      <remap from="~rgb_radarimg" to="homography/rgb_radarimg" />

    </node>

    <!-- voxel grid + z filter -->
    <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid $(arg nodelet_name)" output="screen">
      <remap from="~input" to="projection/cloud" /> <!-- remap from=sink to=source -->
      <rosparam>
        filter_field_name: z
        filter_limit_min: -0.0
        filter_limit_max: 2.0
        filter_limit_negative: False
        leaf_size: 0.1
      </rosparam>
    </node>

    <!-- cluster extraction to obstacles -->
    <node pkg="nodelet" type="nodelet" name="extraction" respawn="true" output="screen"
      args="load $(arg package_name)/ObstacleExtractionNodelet $(arg nodelet_name)" >

      <remap from="~input" to="voxel_grid/output" />
      
      <rosparam>
        cluster_tolerance: 2.0
        min_cluster_size: 5
      </rosparam>
    </node>

    <!-- 
      NMEA reporting node, unclassified obstacles
      Subscriptions:
        ~input: [asv_perception_common/ObstacleArray.msg]  obstacles to report
      Publications:
        ~output: [nmea_msgs/Sentence]  NMEA sentence
    -->
    <node name="nmea_report_unclassified" pkg="$(arg package_name)" type="nmea_report_node.py" output="screen">
      <remap from="~input" to="extraction/output" />
    </node>
    
    <!-- 
      NMEA reporting node, classified obstacles
    -->
    <node name="nmea_report_classified" pkg="$(arg package_name)" type="nmea_report_node.py" output="screen">
      <remap from="~input" to="projection/obstacles" />
    </node>
    
    <!-- Rviz visualization markers:  classified obstacles -->
    <node pkg="nodelet" type="nodelet" name="visualization_classified" args="load $(arg package_name)/ObstacleVisualizationNodelet $(arg nodelet_name)" output="screen">
      <remap from="~input" to="projection/obstacles" />
      <rosparam>
        marker_duration_secs: 0
        marker_duration_nsecs: 150000000
        show_position_frame:  'utm'
      </rosparam>
    </node>

    <!-- Rviz visualization markers:  unclassified obstacles -->
    <node pkg="nodelet" type="nodelet" name="visualization_unclassified" args="load $(arg package_name)/ObstacleVisualizationNodelet $(arg nodelet_name)" output="screen">
      <remap from="~input" to="extraction/output" />
      <rosparam>
        marker_duration_secs: 0
        marker_duration_nsecs: 400000000
      </rosparam>
    </node>
    
  </group>

</launch>
