<?xml version="1.0" encoding="utf-8"?>
<launch>
    <arg name="package_name" value="asv_perception_homography"/>
    <arg name="node_name" default="homography"/>
    
    <arg name="imu_topic" />
    <arg name="camera0_image_topic" />
    <arg name="camera0_calibration_file" />
    <arg name="camera1_image_topic" />
    <arg name="camera1_calibration_file" />
    <arg name="camera2_image_topic" />
    <arg name="camera2_calibration_file" />

    <!-- camera0 -->
    <include file="$(find asv_perception_homography)/launch/camera.launch" ns="camera0">
        <arg name="image_topic" value="$(arg camera0_image_topic)" />
        <arg name="imu_topic" value="$(arg imu_topic)" />
        <arg name="radar_topic" value="/homography/radar_image/output" />
        <arg name="calibration_file" default="$(arg camera0_calibration_file)" />
    </include>

    <!-- camera1 -->
    <include file="$(find asv_perception_homography)/launch/camera.launch" ns="camera1">
        <arg name="image_topic" value="$(arg camera1_image_topic)" />
        <arg name="imu_topic" value="$(arg imu_topic)" />
        <arg name="radar_topic" value="/homography/radar_image/output" />
        <arg name="calibration_file" default="$(arg camera1_calibration_file)" />
    </include>

    <!-- camera2 -->
    <include file="$(find asv_perception_homography)/launch/camera.launch" ns="camera2">
        <arg name="image_topic" value="$(arg camera2_image_topic)" />
        <arg name="imu_topic" value="$(arg imu_topic)" />
        <arg name="radar_topic" value="/homography/radar_image/output" />
        <arg name="calibration_file" default="$(arg camera2_calibration_file)" />
    </include>

    <group ns="homography">
        <!-- 
        pointcloud concat for radar segments
        -->
        <arg name="nodelet_name" value="$(arg package_name)_nodelet" />
        <node pkg="nodelet" type="nodelet" name="$(arg nodelet_name)" args="manager" respawn="true" />

        <!-- voxel grid, transform points to base_link frame -->
        <node pkg="nodelet" type="nodelet" name="grid_filter" args="load pcl/VoxelGrid $(arg nodelet_name)" output="screen">

            <remap from="~input" to="/broadband_radar/channel_0/pointcloud" /> <!-- remap from=sink to=source -->

            <rosparam>
                leaf_size: 0.1
                output_frame:  'base_link'
            </rosparam>
        </node>

        <!-- pointcloud concat for radar -->
        <node pkg="nodelet" type="nodelet" name="concat" output="screen"
            args="load asv_perception_obstacleid/PointCloudConcatNodelet $(arg nodelet_name)" >

            <remap from="~input" to="grid_filter/output" />

            <rosparam>
                decay_time:  1.5
            </rosparam>
        </node>

        <!-- use concat pointcloud, create image -->
        <node name="radar_image" pkg="$(arg package_name)" type="imager.py" output="screen">
            <remap from="~input" to="concat/current" />
            <rosparam>
                max_range: 500
                image_size: 1024
            </rosparam>
        </node>
    </group>

</launch>

